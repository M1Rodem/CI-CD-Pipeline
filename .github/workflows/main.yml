  security:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install and run ClamAV
        run: |
          sudo apt-get update
          sudo apt-get install -y clamav clamav-daemon
          sudo freshclam  # Обновляем базы вирусов
          clamscan --recursive --infected --exclude-dir=.git . || true
          echo "ClamAV scan completed"

      - name: Run ShellCheck linter (для bash-скриптов)
        run: |
          # Ищем все .sh файлы и проверяем их
          find . -name "*.sh" -type f | while read file; do
            echo "Linting $file"
            docker run --rm -v "$(pwd):/mnt" koalaman/shellcheck:stable "$file" || true
          done
          echo "ShellCheck completed"

      - name: Add sec-passed label to PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['sec-passed']
            })